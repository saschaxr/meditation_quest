{"version":3,"file":"vircadia-audio-input.js","mappings":"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","sources":["webpack://@vircadia/web-sdk/./src/domain/audio/AudioConstants.ts","webpack://@vircadia/web-sdk/webpack/bootstrap","webpack://@vircadia/web-sdk/webpack/runtime/define property getters","webpack://@vircadia/web-sdk/webpack/runtime/hasOwnProperty shorthand","webpack://@vircadia/web-sdk/webpack/runtime/make namespace object","webpack://@vircadia/web-sdk/./src/domain/worklets/AudioInputProcessor.ts"],"sourcesContent":["//\n//  AudioConstants.ts\n//\n//  Created by David Rowe on 11 Sep 2021.\n//  Copyright 2021 Vircadia contributors.\n//  Copyright 2021 DigiSomni LLC.\n//\n//  Distributed under the Apache License, Version 2.0.\n//  See the accompanying file LICENSE or http://www.apache.org/licenses/LICENSE-2.0.html\n//\n\n/*@devdoc\n *  The <code>AudioConstants</code> namespace provides the values of audio constants used in the SDK.\n *  <p>C++: <code>AudioConstants</code></p>\n *\n *  @namespace AudioConstants\n *\n *  @property {number} SAMPLE_RATE - <code>24000</code> - The audio sample rate, in Hz.\n *\n *  @property {number} STEREO - <code>2</code> - The number of audio channels for stereo.\n *\n *  @property {number} NETWORK_FRAME_SAMPLES_STEREO - <code>480</code> - The number of samples in a network packet for a stereo\n *      channel.\n *  @property {number} NETWORK_FRAME_SAMPLES_PER_CHANNEL - <code>240</code> - The number of samples in a network packet per\n *      channel.\n *\n *  @property {number} NETWORK_FRAME_SECS - <code>0.01</code> - The interval between audio network packets, in seconds.\n *  @property {number} NETWORK_FRAME_MSECS - <code>10</code> - The interval between audio network packets, in milliseconds.\n *\n *  @property {number} AUDIO_WORKLET_BLOCK_SIZE - <code>128</code> - The number of frames in and audio worklet audio block.\n */\nconst AudioConstants = new class {\n    // C++  AudioConstants\n\n    /* eslint-disable @typescript-eslint/no-magic-numbers */\n\n    readonly SAMPLE_RATE = 24000;\n\n    readonly STEREO = 2;\n\n    readonly NETWORK_FRAME_SAMPLES_STEREO = 480;\n    readonly NETWORK_FRAME_SAMPLES_PER_CHANNEL = 240;\n\n    readonly NETWORK_FRAME_SECS = this.NETWORK_FRAME_SAMPLES_PER_CHANNEL / this.SAMPLE_RATE;\n    readonly NETWORK_FRAME_MSECS = this.NETWORK_FRAME_SECS * 1000;\n\n    readonly AUDIO_WORKLET_BLOCK_SIZE = 128;  // 128 frames of samples.\n\n}();\n\nexport { AudioConstants as default };\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","//\n//  AudioInputProcessor.ts\n//\n//  Created by David Rowe on 23 Sep 2021.\n//  Copyright 2021 Vircadia contributors.\n//  Copyright 2021 DigiSomni LLC.\n//\n//  Distributed under the Apache License, Version 2.0.\n//  See the accompanying file LICENSE or http://www.apache.org/licenses/LICENSE-2.0.html\n//\n\nimport AudioConstants from \"../audio/AudioConstants\";\n\n// see: https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletGlobalScope\ndeclare const sampleRate: number;\n\n/*@devdoc\n *  The <code>AudioInputProcessor</code> class implements a Web Audio\n *  {@link https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletProcessor|AudioWorkletProcessor} that takes incoming Web\n *  Audio and provides it for the SDK to use. It is used as a node in a Web Audio graph in {@link AudioInput}.\n *  <p>It runs on its own thread and buffers incoming samples as needed in order to provide the samples to the SDK in the\n *  required network frame size.</p>\n *  <p>C++: <code>N/A</code></p>\n *  @class AudioInputProcessor\n *  @param {AudioWorkletNodeOptions} options -\n *    {@link https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletProcessor/AudioWorkletProcessor|AudioWorkletProcessor}\n *    options.\n *\n *  @property {MessagePort} port - Used to communicate between the AudioWorkletProcessor object and its internal code. See\n *    {@link https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletNode/port|AudioWorkletNode.port}.\n */\nclass AudioInputProcessor extends AudioWorkletProcessor {\n\n    // FIXME: All these fields should be private (#s) but Firefox is handling transpiled code with them (Sep 2021).\n    readonly FLOAT_TO_INT = 32767;\n    readonly LITTLE_ENDIAN = true;\n\n    _channelCount;\n\n    _output: Int16Array;\n    _outputView: DataView;\n    _outputSize: number;\n    _outputSampleSize: number;\n    _outputIndex = 0;\n\n    _inputSampleRate: number;\n    _inputFraction = 0.0;\n    _inputSampleCount = 0;\n\n    // Downsampling.\n    _downsampleRatio = 1.0;\n    _inputAccumulator = [0.0, 0.0];\n\n    // Upsampling.\n    _upsampleRatio = 1.0;\n    _lastInputValues = [0.0, 0.0];\n\n    _processor: ((input: Array<Float32Array>) => void);\n    _haveReportedUpSampleError = false;\n\n\n    constructor(options?: AudioWorkletNodeOptions) {\n        super(options);  // eslint-disable-line\n\n        this._channelCount = options?.channelCount ? options.channelCount : 1;  // Default to mono.\n        this._channelCount = Math.min(this._channelCount, 2);  // Mono or stereo output, only.\n        this._inputSampleRate = sampleRate;\n\n        if (this._inputSampleRate === AudioConstants.SAMPLE_RATE) {\n            this._processor = this._convert;\n        } else if (this._inputSampleRate > AudioConstants.SAMPLE_RATE) {\n            this._processor = this._downsample;\n            this._downsampleRatio = AudioConstants.SAMPLE_RATE / this._inputSampleRate;  // < 1.0\n            this._inputFraction = 0.0;\n        } else {\n            this._processor = this._upsample;\n            this._upsampleRatio = this._inputSampleRate / AudioConstants.SAMPLE_RATE;  // < 1.0\n            this._inputFraction = this._upsampleRatio;\n        }\n\n        this._outputSize = this._channelCount === 1\n            ? AudioConstants.NETWORK_FRAME_SAMPLES_PER_CHANNEL\n            : AudioConstants.NETWORK_FRAME_SAMPLES_STEREO;\n        this._outputSampleSize = this._outputSize / this._channelCount;\n        this._output = new Int16Array(this._outputSize);\n        this._outputView = new DataView(this._output.buffer);\n\n        this.port.onmessage = this.onMessage;\n    }\n\n    /*@devdoc\n     *  Acts upon commands posted to the audio worklet's message port.\n     *  @function AudioInputProcessor.onMessage\n     *  @param {MessageEvent} message - The message posted to the audio worklet, with <code>message.data</code> being a string\n     *      signifying the command. The following command is expected:\n     *      <p><code>\"clear\"</code>: Clear the audio sample buffer.</p>\n     */\n    onMessage = (message: MessageEvent) => {\n        if (message.data === \"clear\") {\n            this._resetInput();\n            this._resetOutput();\n        }\n    };\n\n    /*@devdoc\n     *  Called by the Web Audio pipeline to handle the next block of input audio samples, converting them to int16 samples at a\n     *  24000Hz sample rate and outputting them 240 frames at a time by posting a message on the AudioWorkletProcessor port.\n     *  @param {Float32Array[][]} inputList - Input PCM audio samples. An array of inputs, each of which is an array of\n     *      channels, each of which has 128 float32 samples in the range <code>-1.0</code> &ndash; <code>1.0</code>.\n     *  @param {Float32Array[][]} outputList - Output PCM audio samples. <em>Not used.</em>\n     *  @param {Record<string, Float32Array>} parameters - Processing parameters. <em>Not used.</em>\n     *  @returns {boolean} <code>true</code> to keep the processor node alive.\n     */\n    // eslint-disable-next-line\n    // @ts-ignore\n    process(inputList: Float32Array[][] /* , outputList: Float32Array[][], parameters: Record<string, Float32Array> */) {\n        if (!inputList || !inputList[0] || !inputList[0][0] || this._channelCount === 2 && !inputList[0][1]) {\n            return true;\n        }\n\n        this._processor(inputList[0]);\n\n        return true;\n    }\n\n    _resetOutput() {\n        this._output = new Int16Array(this._outputSize);\n        this._outputView = new DataView(this._output.buffer);\n        this._outputIndex = 0;\n    }\n\n    _resetInput() {\n        this._inputSampleCount = 0;\n        this._inputFraction = 0.0;\n        this._inputAccumulator = [0.0, 0.0];\n        // Do not reset this._lastInputValue.\n    }\n\n    _convert = (input: Array<Float32Array>) => {\n        // A straight conversion from float32 to int16 values, posting the output buffer when full.\n        const BYTES_PER_INT16_SAMPLE = 2;\n        const BYTES_PER_INT16_FRAME = this._channelCount * BYTES_PER_INT16_SAMPLE;\n\n        for (let i = 0, inputSize = (input[0] as Float32Array).length; i < inputSize; i++) {\n\n            const rawIndex = this._outputIndex * BYTES_PER_INT16_FRAME;\n            for (let channel = 0; channel < this._channelCount; channel++) {\n                const inputSample = (input[channel] as Float32Array)[i] as number;\n                const rawChannel = channel * BYTES_PER_INT16_SAMPLE;\n                this._outputView.setInt16(rawIndex + rawChannel, inputSample * this.FLOAT_TO_INT, this.LITTLE_ENDIAN);\n            }\n\n            this._outputIndex += 1;\n            if (this._outputIndex === this._outputSampleSize) {\n                this.port.postMessage(this._output.buffer, [this._output.buffer]);\n                this._resetOutput();\n            }\n\n        }\n\n    };\n\n    _downsample = (input: Array<Float32Array>) => {\n        // A simple low-pass filter that assigns proportions of each input sample to output samples, posting the output buffer\n        // when full. Values are resynchronized every second to avoid error accumulation.\n        const BYTES_PER_INT16_SAMPLE = 2;\n        const BYTES_PER_INT16_FRAME = this._channelCount * BYTES_PER_INT16_SAMPLE;\n\n        /* eslint-disable @typescript-eslint/no-non-null-assertion */\n\n        for (let i = 0, inputSize = (input[0] as Float32Array).length; i < inputSize; i++) {\n            this._inputSampleCount += 1;\n\n            if (this._inputFraction + this._downsampleRatio < 1.0 && this._inputSampleCount !== this._inputSampleRate) {\n                // End of input sample < end of output sample, provided that it's not the final sample in a second (avoid\n                // possible accumulated error condition).\n\n                for (let channel = 0; channel < this._channelCount; channel++) {\n                    // Add whole of input to input accumulator.\n                    this._inputAccumulator[channel] += (input[channel] as Float32Array)[i] as number;\n                    this._inputFraction += this._downsampleRatio;\n                }\n\n            } else {\n                // End of input sample >= end of output sample, or final sample of a second.\n\n                const rawIndex = this._outputIndex * BYTES_PER_INT16_FRAME;\n                for (let channel = 0; channel < this._channelCount; channel++) {\n                    // Add proportion of input to input accumulator.\n                    const proportion = (1 - this._inputFraction) / this._downsampleRatio;\n                    const value = (input[channel] as Float32Array)[i] as number;\n                    this._inputAccumulator[channel] += proportion * value;\n\n                    // Convert and write output.\n                    const rawChannel = channel * BYTES_PER_INT16_SAMPLE;\n                    this._outputView.setInt16(rawIndex + rawChannel,\n                        this._inputAccumulator[channel]! * this._downsampleRatio * this.FLOAT_TO_INT, this.LITTLE_ENDIAN);\n\n                    // Set input accumulator to remainder of input.\n                    const remainder = 1.0 - proportion;\n                    this._inputFraction = remainder * this._downsampleRatio;\n                    this._inputAccumulator[channel] = remainder * value;\n                }\n\n                this._outputIndex += 1;\n            }\n\n            // Post output if buffer full.\n            if (this._outputIndex === this._outputSampleSize) {\n                this.port.postMessage(this._output.buffer, [this._output.buffer]);\n                this._resetOutput();\n            }\n\n            // Reset input each second to avoid accumulated errors.\n            if (this._inputSampleCount === this._inputSampleRate) {\n                this._resetInput();\n            }\n\n            /* eslint-enable @typescript-eslint/no-non-null-assertion */\n        }\n    };\n\n    _upsample = (input: Array<Float32Array>) => {\n        // A simple linear interpolation resampler, posting the output buffer when full. Values are resynchronized every second\n        // to avoid error accumulation.\n        const BYTES_PER_INT16_SAMPLE = 2;\n        const BYTES_PER_INT16_FRAME = this._channelCount * BYTES_PER_INT16_SAMPLE;\n\n        /* eslint-disable @typescript-eslint/no-non-null-assertion */\n\n        const inputSize = (input[0] as Float32Array).length;\n        let inputIndex = 0;\n        let inputValues = [];\n        for (let channel = 0; channel < this._channelCount; channel++) {\n            inputValues.push((input[channel] as Float32Array)[0] as number);\n        }\n\n        // Process input into output.\n        while (inputIndex < inputSize) {\n\n            // Calculate output value = last-input-value + fraction * (this-input-value - last-input-value).\n            const rawIndex = this._outputIndex * BYTES_PER_INT16_FRAME;\n            for (let channel = 0; channel < this._channelCount; channel++) {\n                const rawChannel = channel * BYTES_PER_INT16_SAMPLE;\n                const lastValue = this._lastInputValues[channel]!;\n                const nextValue = inputValues[channel]!;\n                this._outputView.setInt16(rawIndex + rawChannel,\n                    lastValue + this._inputFraction * (nextValue - lastValue) * this.FLOAT_TO_INT, this.LITTLE_ENDIAN);\n            }\n            this._outputIndex += 1;\n\n            // Post output if buffer full.\n            if (this._outputIndex === this._outputSampleSize) {\n                this.port.postMessage(this._output.buffer, [this._output.buffer]);\n                this._resetOutput();\n            }\n\n            this._inputFraction += this._upsampleRatio;\n            if (this._inputFraction > 1.0) {\n\n                // Advance to the next pair of inputs.\n                this._lastInputValues = inputValues;\n                inputIndex += 1;\n                if (inputIndex < inputSize) {\n                    this._inputSampleCount += 1;\n                    inputValues = [];\n                    for (let channel = 0; channel < this._channelCount; channel++) {\n                        inputValues.push((input[channel] as Float32Array)[inputIndex] as number);\n                    }\n                }\n\n                this._inputFraction -= 1.0;\n            }\n\n            // Reset input each second to avoid accumulated errors.\n            if (this._inputSampleCount === this._inputSampleRate) {\n                this._resetInput();\n            }\n        }\n\n        /* eslint-enable @typescript-eslint/no-non-null-assertion */\n    };\n\n}\n\nregisterProcessor(\"vircadia-audio-input-processor\", AudioInputProcessor);\n"],"names":[],"sourceRoot":""}